class ViEvent{constructor(){this.map={}}on(a,b){return this.map[a]?void this.map[a].push(b):void(this.map[a]=[b])}emit(a,...b){this.map[a].forEach(a=>{a(...b)})}}function styleInject(a,b){void 0===b&&(b={});var c=b.insertAt;if(a&&"undefined"!=typeof document){var d=document.head||document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css","top"===c?d.firstChild?d.insertBefore(e,d.firstChild):d.appendChild(e):d.appendChild(e),e.styleSheet?e.styleSheet.cssText=a:e.appendChild(document.createTextNode(a))}}var css=".vi-upload-input-wrapper {\n  float: left;\n  overflow: hidden;\n}\n.vi-upload-input-wrapper .vi-upload-input-wrapper-box{\n  position: relative;\n  width: 80px;\n  height: 80px;\n  margin: 0 10px 10px 0;\n  box-sizing: border-box;\n  background-color: #fff;\n  box-shadow: 0 0 6px 2px rgba(0, 0, 0, 0.08);\n  border-radius: 2px;\n}\n.vi-upload-input-wrapper .vi-upload-input-wrapper-box:before {\n  content: \"\";\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 20px;\n  height: 2px;\n  background-color: #666;\n  transform: translate(-50%, -50%);\n}\n.vi-upload-input-wrapper .vi-upload-input-wrapper-box:after {\n  content: \"\";\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 20px;\n  height: 2px;\n  background-color: #666;\n  transform: translate(-50%, -50%) rotate(90deg);\n}\n.vi-upload-input {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  font-size: 0;\n  opacity: 0;\n}\n.vi-upload-file {\n  float: left;\n  margin: 0 10px 10px 0;\n}\n.vi-upload-file .vi-upload-file-box {\n  position: relative;\n  width: 80px;\n  height: 80px;\n  box-sizing: border-box;\n  background-color: #fff;\n  box-shadow: 0 0 6px 2px rgba(0, 0, 0, 0.08);\n  border-radius: 2px;\n  background-size: cover;\n}\n.vi-upload-file .vi-upload-file-box .vi-upload-file-delete {\n  position: absolute;\n  z-index: 2;\n  top: -36px;\n  right: -36px;\n  width: 80px;\n  height: 80px;\n  background: #000;\n  border-radius: 50%;\n  transform: scale(0.25);\n}\n.vi-upload-file .vi-upload-file-box .vi-upload-file-delete:before {\n  content: '';\n  position: absolute;\n  width: 6px;\n  height: 45px;\n  top: 50%;\n  left: 50%;\n  border-radius: 6px;\n  background-color: #fff;\n  transform: translate(-50%, -50%) rotate(135deg);\n}\n.vi-upload-file .vi-upload-file-box .vi-upload-file-delete:after {\n  content: '';\n  position: absolute;\n  width: 6px;\n  height: 45px;\n  top: 50%;\n  left: 50%;\n  border-radius: 6px;\n  background-color: #fff;\n  transform: translate(-50%, -50%) rotate(-135deg);\n}\n";styleInject(".vi-upload-input-wrapper {\n  float: left;\n  overflow: hidden;\n}\n.vi-upload-input-wrapper .vi-upload-input-wrapper-box{\n  position: relative;\n  width: 80px;\n  height: 80px;\n  margin: 0 10px 10px 0;\n  box-sizing: border-box;\n  background-color: #fff;\n  box-shadow: 0 0 6px 2px rgba(0, 0, 0, 0.08);\n  border-radius: 2px;\n}\n.vi-upload-input-wrapper .vi-upload-input-wrapper-box:before {\n  content: \"\";\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 20px;\n  height: 2px;\n  background-color: #666;\n  transform: translate(-50%, -50%);\n}\n.vi-upload-input-wrapper .vi-upload-input-wrapper-box:after {\n  content: \"\";\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 20px;\n  height: 2px;\n  background-color: #666;\n  transform: translate(-50%, -50%) rotate(90deg);\n}\n.vi-upload-input {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  font-size: 0;\n  opacity: 0;\n}\n.vi-upload-file {\n  float: left;\n  margin: 0 10px 10px 0;\n}\n.vi-upload-file .vi-upload-file-box {\n  position: relative;\n  width: 80px;\n  height: 80px;\n  box-sizing: border-box;\n  background-color: #fff;\n  box-shadow: 0 0 6px 2px rgba(0, 0, 0, 0.08);\n  border-radius: 2px;\n  background-size: cover;\n}\n.vi-upload-file .vi-upload-file-box .vi-upload-file-delete {\n  position: absolute;\n  z-index: 2;\n  top: -36px;\n  right: -36px;\n  width: 80px;\n  height: 80px;\n  background: #000;\n  border-radius: 50%;\n  transform: scale(0.25);\n}\n.vi-upload-file .vi-upload-file-box .vi-upload-file-delete:before {\n  content: '';\n  position: absolute;\n  width: 6px;\n  height: 45px;\n  top: 50%;\n  left: 50%;\n  border-radius: 6px;\n  background-color: #fff;\n  transform: translate(-50%, -50%) rotate(135deg);\n}\n.vi-upload-file .vi-upload-file-box .vi-upload-file-delete:after {\n  content: '';\n  position: absolute;\n  width: 6px;\n  height: 45px;\n  top: 50%;\n  left: 50%;\n  border-radius: 6px;\n  background-color: #fff;\n  transform: translate(-50%, -50%) rotate(-135deg);\n}\n");function hasClass(a,b){const c=new RegExp("(^|\\s)"+b+"(\\s|$)");return c.test(a.className)}function addClass(a,b){/* istanbul ignore if */if(!hasClass(a,b)){const c=a.className.split(" ");c.push(b),a.className=c.join(" ")}}function checkClass(a){return Object.prototype.toString.call(a).slice(8,-1)}function deepClone(a){let b,c=checkClass(a);if("Array"===c)b=[];else if("Object"===c)b={};else return a;for(let c in a){let d=a[c],e=checkClass(d);b[c]="Object"===e?deepClone(d):"Array"===e?deepClone(d):d}return b}/**
 *
 * 给target合并key(深度)
 * @export
 * @param {Object} to
 * @param {Object} from
 * @returns
 */function deepAssign(a,b){for(let c in b)a[c]&&"object"==typeof a[c]?deepAssign(a[c],b[c]):a[c]=b[c]}/**
 * 支持多参数的深度克隆
 * 后面的优先级最大
 * @export
 * @param {Object} target
 * @param {Object} rest
 * @returns
 */function mulitDeepClone(a,...b){for(let c,d=0;d<b.length;d++)c=deepClone(b[d]),deepAssign(a,c);return a}function createURL(a){const b=window.URL||window.webkitURL||window.mozURL;return a&&b?b.createObjectURL(a):""}function prependChild(a,b,c){a.children[0]?a.insertBefore(b,c):a.appendChild(b)}function observeProperty(a,b,c){var d=a[b];Object.defineProperty(a,b,{get:function(){return d},set:function(a){d===a||(d=a,"function"==typeof c&&c(a))}})}const DEFAULT_OPTIONS={// 容器
el:"",// 上传文件的个数
max:1,// 文件的最大存储
maxSize:0,// 自定义的容器,下版本
slot:{}},EVENT_ADD_FILES="addFiles",EVENT_CHANGE_FILES="changeFiles",EVENT_REMOVE_FILES="removeFiles";class ViUpload{constructor(a){this.options=mulitDeepClone({},DEFAULT_OPTIONS,a),this.checkType(),this.init()}init(){let a=this.initWrapper();a&&(this.initData(),this.listenEvent(),this.watch())}checkType(){/#.+/.test(this.options.el)||console.error(`type check failed for options "el". please use id selector`),"number"!=typeof this.options.maxSize&&console.error(`type check failed for options "maxSize".`),"number"!=typeof this.options.max&&console.error(`type check failed for options "max".`)}initWrapper(){let a=this.options.el.slice(1);return(this.el=document.getElementById(a),!this.el)?(console.error(`cannot find selector #${this.el}.`),!1):(this.createInput(),!0)}initData(){this.imgList=[],this.restImgLength=this.options.max}listenEvent(){this.ViEvent=new ViEvent,this.ViEvent.on(EVENT_ADD_FILES,a=>{"function"==typeof this.options.events[EVENT_ADD_FILES]&&this.options.events[EVENT_ADD_FILES](a)}),this.ViEvent.on(EVENT_CHANGE_FILES,a=>{"function"==typeof this.options.events[EVENT_CHANGE_FILES]&&this.options.events[EVENT_CHANGE_FILES](a)}),this.ViEvent.on(EVENT_REMOVE_FILES,a=>{"function"==typeof this.options.events[EVENT_REMOVE_FILES]&&this.options.events[EVENT_REMOVE_FILES](a)})}watch(){this.watchRestImgLength()}watchRestImgLength(){observeProperty(this,"restImgLength",a=>{this.inputWrapper.style.display=0<a?"block":"none",this.ViEvent.emit(EVENT_CHANGE_FILES,this.imgList)})}createInput(){this.inputWrapper=document.createElement("div"),addClass(this.inputWrapper,"vi-upload-input-wrapper"),this.inputWrapper.innerHTML=`<div class="vi-upload-input-wrapper-box">
                      <input class="vi-upload-input"
                        type="file"
                        multiple="multiple"
                        accept="image/*" />
                    </div>`,this.el.appendChild(this.inputWrapper);let a=this.inputWrapper.getElementsByTagName("input")[0];a.onchange=a=>{const b=a.currentTarget;let c=mulitDeepClone({},b),d=c.files,e=[],f=0,g=d[f];for(;e.length<d.length&&g;){let a=createURL(g);e.push(g),g.url=a,g=d[++f]}this.ViEvent.emit(EVENT_ADD_FILES,e),this.createImg(e)}}createImg(a){let b=[],c=0,d=a[c];for(;b.length<this.restImgLength&&d;)b.push(d),d=a[++c];for(let c,d=0;d<b.length;d++){if(c=b[d],c.size>this.options.maxSize){console.warn(`the size of ${d}th picture exceeds the options maxSize`);continue}this.imgList.push(c),this.restImgLength=this.options.max-this.imgList.length;let a=document.createElement("div");addClass(a,"vi-upload-file"),a.innerHTML=`<div class="vi-upload-file-box">
                            <i class="vi-upload-file-delete"></i>
                          </div>`;let e=a.getElementsByClassName("vi-upload-file-box")[0];e.style.backgroundImage=`url(${c.url})`,a.appendChild(e),prependChild(this.el,a,this.inputWrapper);let f=a.getElementsByClassName("vi-upload-file-delete")[0];f.onclick=b=>{b.stopPropagation();let c=this.imgList.splice(d,1);this.restImgLength=this.options.max-this.imgList.length,this.el.removeChild(a),this.ViEvent.emit(EVENT_REMOVE_FILES,c)}}}}export default ViUpload;
